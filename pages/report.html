<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>KUBER ONE - Reports</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">

  <script src="https://www.gstatic.com/firebasejs/11.10.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.10.0/firebase-auth-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root {
      --primary: #1e40af;
      --secondary: #f59e0b;
      --danger: #dc3545;
      --success: #28a745;
      --dark: #1e293b;
      --light: #f8fafc;
      --warning: #f97316;
    }

    body {
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      padding: 20px 10px;
    }

    .report-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
      overflow: hidden;
      margin-bottom: 30px;
      transition: all 0.3s ease;
    }

    .report-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.18);
    }

    .card-header {
      background: linear-gradient(135deg, var(--primary), #2563eb);
      color: white;
      padding: 18px 24px;
      font-weight: 700;
      font-size: 1.2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-header .bi {
      font-size: 1.5rem;
    }

    .card-body {
      padding: 24px;
    }

    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      align-items: center;
      margin-bottom: 24px;
      background: #f8fafc;
      padding: 16px;
      border-radius: 14px;
      border: 1px solid #e2e8f0;
      position: relative !important;
      z-index: 1000 !important;
    }

    .form-control,
    .form-select {
      border-radius: 12px;
      padding: 11px 16px;
      font-size: 0.95rem;
      border: 1.5px solid #cbd5e1;
    }

    .form-control:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(30, 102, 235, 0.15);
    }

    .btn {
      border-radius: 12px;
      font-weight: 600;
      padding: 11px 20px;
      transition: all 0.2s;
    }

    .btn:hover {
      transform: translateY(-2px);
    }

    .btn-primary {
      background: var(--primary);
      border: none;
    }

    .btn-success {
      background: var(--success);
      border: none;
    }

    .btn-danger {
      background: var(--danger);
      border: none;
    }

    .btn-warning {
      background: var(--warning);
      border: none;
    }

    .table {
      margin: 0;
      font-size: 0.94rem;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }

    .table thead {
      background: #e2e8f0;
    }

    .table th {
      font-weight: 700;
      color: #1e293b;
      font-size: 0.95rem;
    }

    .table tbody tr:hover {
      background: #f0f9ff;
    }

    .badge {
      font-weight: 600;
      padding: 7px 14px;
      border-radius: 10px;
      font-size: 0.85rem;
    }

    .cancelled-table .table thead {
      background: var(--danger);
      color: white;
    }

    .cancelled-table .table tbody tr {
      background: #fee2e2;
      border-left: 5px solid var(--danger);
    }

    .client-search-wrapper {
      position: relative;
      width: 300px;
      z-index: 9999999;
    }

    #clientSearchResults {
      position: absolute;
      top: 100% !important;
      left: 0 !important;
      width: 100% !important;
      max-height: 360px;
      overflow-y: auto;
      background: white;
      border: 2px solid #3b82f6;
      border-top: none;
      border-radius: 0 0 16px 16px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
      z-index: 9999999 !important;
      margin-top: -1px;
      display: none;
      padding: 12px 0;
    }

    .search-result-item {
      padding: 16px 20px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .search-result-item:hover {
      background: #dbeafe;
      padding-left: 28px;
      border-left: 6px solid #3b82f6;
    }

    .search-result-item:last-child {
      border-bottom: none;
    }

    .search-result-name {
      font-weight: 700;
      color: #1e40af;
      font-size: 1.05rem;
    }

    .search-result-contact {
      font-size: 0.9rem;
      color: #475569;
      margin-top: 4px;
    }

    @media (max-width: 768px) {
      .filter-bar {
        flex-direction: column;
        align-items: stretch;
      }

      .btn {
        width: 100%;
        margin: 5px 0;
      }

      .client-search-wrapper,
      #clientSearchResults {
        width: 100% !important;
      }
    }
  </style>
</head>

<body>

  <div class="container-fluid">

    <!-- DAILY SUMMARY -->
    <div class="report-card">
      <div class="card-header">
        <span>Daily Sales Summary</span>
        <i class="bi bi-calendar-check-fill"></i>
      </div>
      <div class="card-body">
        <div class="filter-bar">
          <input type="date" id="summaryFromDate" class="form-control" style="width:170px;">
          <input type="date" id="summaryToDate" class="form-control" style="width:170px;">
          <button class="btn btn-primary" onclick="loadDailySummary()">Load Data</button>
          <button class="btn btn-success"
            onclick="downloadTableToExcel('dailySummaryTable', 'Daily_Sales')">Excel</button>
          <button class="btn btn-danger" onclick="downloadTableToPDF('dailySummaryTable', 'Daily_Sales')">PDF</button>
        </div>
        <div class="table-responsive">
          <table id="dailySummaryTable" class="table table-hover">
            <thead>
              <tr>
                <th>Invoice No</th>
                <th>Client</th>
                <th>Date</th>
                <th>GST %</th>
                <th>Total</th>
                <th>Paid</th>
                <th>Pending</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="8" class="text-center text-muted py-5">Click Load Data to see all invoices</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- CLIENT REPORT -->
    <div class="report-card">
      <div class="card-header">
        <span>Client-wise Report</span>
        <i class="bi bi-person-lines-fill"></i>
      </div>
      <div class="card-body">
        <div class="filter-bar">
          <div class="client-search-wrapper">
            <input type="text" id="clientSearchInput" class="form-control"
              placeholder="Search Client by Name / Mobile..." autocomplete="off">
            <div id="clientSearchResults"></div>
          </div>
          <input type="hidden" id="selectedClientName">
          <input type="date" id="clientFromDate" class="form-control" style="width:160px;">
          <input type="date" id="clientToDate" class="form-control" style="width:160px;">
          <button class="btn btn-primary" onclick="loadClientReport()">Load</button>
          <button class="btn btn-success"
            onclick="downloadTableToExcel('clientReportTable', 'Client_Report')">Excel</button>
          <button class="btn btn-danger" onclick="downloadTableToPDF('clientReportTable', 'Client_Report')">PDF</button>
        </div>
        <div class="table-responsive">
          <table id="clientReportTable" class="table table-hover">
            <thead>
              <tr>
                <th>Invoice</th>
                <th>Date</th>
                <th>GST %</th>
                <th>Total</th>
                <th>Paid</th>
                <th>Pending</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="7" class="text-center text-muted py-5">Search and select a client</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ITEM-WISE GST REPORT -->
    <div class="report-card">
      <div class="card-header">
        <span>Item-wise Sales + GST Report</span>
        <i class="bi bi-box-seam-fill"></i>
      </div>
      <div class="card-body">
        <div class="filter-bar">
          <input type="date" id="itemFromDate" class="form-control" style="width:170px;">
          <input type="date" id="itemToDate" class="form-control" style="width:170px;">
          <button class="btn btn-primary" onclick="loadItemReport()">Load</button>
          <button class="btn btn-success" onclick="downloadTableToExcel('itemReportTable', 'GST_Sales')">Excel</button>
          <button class="btn btn-danger" onclick="downloadTableToPDF('itemReportTable', 'GST_Sales')">PDF</button>
        </div>
        <div class="table-responsive">
          <table id="itemReportTable" class="table table-hover">
            <thead>
              <tr>
                <th>Item (Brand)</th>
                <th>Qty</th>
                <th>Unit</th>
                <th>Net Sale</th>
                <th>GST %</th>
                <th>GST Amt</th>
                <th>Total Sale</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="7" class="text-center text-muted py-5">Select date range and click Load</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- OUTSTANDING -->
    <div class="report-card">
      <div class="card-header">
        <span>Outstanding Payments</span>
        <i class="bi bi-exclamation-triangle-fill"></i>
      </div>
      <div class="card-body">
        <div class="filter-bar">
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="outFilter" id="filterPending" value="pending" checked>
            <label class="form-check-label" for="filterPending">Pending Only</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="outFilter" id="filterAll" value="all">
            <label class="form-check-label" for="filterAll">All</label>
          </div>
          <button class="btn btn-warning" onclick="loadOutstanding()">Load Outstanding</button>
          <button class="btn btn-success"
            onclick="downloadTableToExcel('outstandingTable', 'Outstanding')">Excel</button>
          <button class="btn btn-danger" onclick="downloadTableToPDF('outstandingTable', 'Outstanding')">PDF</button>
        </div>
        <div class="table-responsive">
          <table id="outstandingTable" class="table table-hover">
            <thead>
              <tr>
                <th>Invoice</th>
                <th>Client</th>
                <th>Contact</th>
                <th>Date</th>
                <th>Payable</th>
                <th>Paid</th>
                <th>Pending</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="8" class="text-center text-muted py-5">Click Load Outstanding to see data</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- CANCELLED -->
    <div class="report-card cancelled-table">
      <div class="card-header" style="background: linear-gradient(135deg, var(--danger), #ef4444);">
        <span>CANCELLED Invoices</span>
        <i class="bi bi-x-circle-fill"></i>
      </div>
      <div class="card-body">
        <div class="filter-bar">
          <button class="btn btn-danger" onclick="loadCancelledReport()">Load All Cancelled</button>
          <button class="btn btn-outline-danger"
            onclick="downloadTableToExcel('cancelledTable', 'CANCELLED')">Excel</button>
          <button class="btn btn-outline-danger"
            onclick="downloadTableToPDF('cancelledTable', 'CANCELLED')">PDF</button>
        </div>
        <div class="table-responsive">
          <table id="cancelledTable" class="table table-hover">
            <thead>
              <tr>
                <th>Invoice No</th>
                <th>Client</th>
                <th>Contact</th>
                <th>Date</th>
                <th>Cancelled On</th>
                <th>Total Amount</th>
                <th>Reason</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="7" class="text-center text-muted py-5">Click Load to see cancelled invoices</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAcXa1P1vgi8rx00psbQnNOfcbv9CGhyCQ",
      authDomain: "hardwaretest-6f55b.firebaseapp.com",
      projectId: "hardwaretest-6f55b",
      storageBucket: "hardwaretest-6f55b.appspot.com",
      messagingSenderId: "1058965019249",
      appId: "1:1058965019249:web:d12b1d52822a450e0f19d0"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let clientContactMap = {};
    let allClients = [];

    function toDDMMYYYY(dateStr) {
      if (!dateStr) return '';
      const [y, m, d] = dateStr.split('-');
      return `${d}-${m}-${y}`;
    }

    function showLoading(title = "Loading...") {
      Swal.fire({
        title: title,
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading(); }
      });
    }

    function normalizeString(str) {
      if (!str) return '';
      return str.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
    }

    async function loadClients() {
      showLoading("Loading Client Data...");
      try {
        const snap = await db.collection("clients").get();
        allClients = [];
        clientContactMap = {};
        snap.forEach(doc => {
          const d = doc.data();
          const name = (d.name || '').toString().trim();
          const contact = (d.contact || '').toString().trim();

          if (name) {
            clientContactMap[name] = contact || 'N/A';
            allClients.push({
              name: name,
              nameNormalized: normalizeString(name),
              contact: contact
            });
          }
        });
        Swal.close();
      } catch (err) {
        console.error(err);
        Swal.fire("Error", "Could not load client data.", "error");
      }
    }

    async function setupClientSearchAfterLoad() {
      await loadClients();

      const input = document.getElementById('clientSearchInput');
      const resultsDiv = document.getElementById('clientSearchResults');

      input.addEventListener('input', function () {
        const query = this.value.trim();
        resultsDiv.innerHTML = '';
        document.getElementById('selectedClientName').value = '';

        if (!query) {
          resultsDiv.style.display = 'none';
          return;
        }

        const queryNormalized = normalizeString(query);
        const mobileQuery = query.replace(/\D/g, '');

        const filtered = allClients.filter(c => {
          const nameMatch = c.nameNormalized.includes(queryNormalized);
          const contactMatch = mobileQuery.length >= 3 && c.contact.includes(mobileQuery);
          return nameMatch || contactMatch;
        }).slice(0, 10);

        if (filtered.length === 0) {
          resultsDiv.innerHTML = '<div class="p-3 text-muted small text-center">No client found</div>';
          resultsDiv.style.display = 'block';
          return;
        }

        filtered.forEach(client => {
          const div = document.createElement('div');
          div.className = 'search-result-item';
          div.innerHTML = `<div class="search-result-name">${client.name}</div><div class="search-result-contact">${client.contact || 'No contact'}</div>`;
          div.onclick = () => {
            input.value = client.name;
            document.getElementById('selectedClientName').value = client.name;
            resultsDiv.innerHTML = '';
            resultsDiv.style.display = 'none';
          };
          resultsDiv.appendChild(div);
        });
        resultsDiv.style.display = 'block';
      });

      input.addEventListener('focus', function () {
        if (this.value.trim()) this.dispatchEvent(new Event('input'));
      });

      document.addEventListener('click', (e) => {
        if (!input.parentElement.contains(e.target)) {
          resultsDiv.style.display = 'none';
        }
      });
    }

    // FIXED: Actual GST % from invoice (withoutGST = 0%)
    function getInvoiceGSTDisplay(inv) {
      if (inv.withoutGST) return { rate: 0, badge: 'bg-secondary' };
      const rate = inv.items?.[0]?.gstRate || 18;
      return { rate, badge: 'bg-info' };
    }

    async function loadDailySummary() {
      let from = toDDMMYYYY(document.getElementById('summaryFromDate').value);
      let to = toDDMMYYYY(document.getElementById('summaryToDate').value);

      showLoading("Loading All Sales...");
      try {
        const snap = await db.collection('invoices').get();
        const tbody = document.querySelector('#dailySummaryTable tbody');
        tbody.innerHTML = '';

        let total = 0, paid = 0, pendingTotal = 0, count = 0;

        snap.forEach(doc => {
          const d = doc.data();
          if (d.cancelled) return;
          if (from && d.date < from) return;
          if (to && d.date > to) return;

          const gstInfo = getInvoiceGSTDisplay(d);
          const payable = d.payable || 0;
          const paidAmt = d.paidAmount || 0;
          const pending = payable - paidAmt;

          total += payable;
          paid += paidAmt;
          pendingTotal += pending;
          count++;

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><strong>${d.invoiceNo}</strong></td>
            <td>${d.client}</td>
            <td>${d.date}</td>
            <td><span class="badge ${gstInfo.badge}">${gstInfo.rate}%</span></td>
            <td>Rs.${payable.toFixed(2)}</td>
            <td>Rs.${paidAmt.toFixed(2)}</td>
            <td>Rs.${pending.toFixed(2)}</td>
            <td><span class="badge bg-${d.cleared ? 'success' : 'danger'}">${d.cleared ? 'Cleared' : 'Pending'}</span></td>
          `;
          tbody.appendChild(tr);
        });

        if (count === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">No invoices found</td></tr>';
        } else {
          tbody.insertAdjacentHTML('beforeend', `
            <tr class="table-primary fw-bold fs-5">
              <td colspan="4">GRAND TOTAL</td>
              <td>Rs.${total.toFixed(2)}</td>
              <td>Rs.${paid.toFixed(2)}</td>
              <td>Rs.${pendingTotal.toFixed(2)}</td>
              <td></td>
            </tr>
          `);
        }
        Swal.close();
      } catch (err) {
        Swal.fire("Error", err.message, "error");
      }
    }

    async function loadClientReport() {
      const clientName = document.getElementById('selectedClientName').value;
      if (!clientName) return Swal.fire("Error", "Select a client!", "warning");

      let from = toDDMMYYYY(document.getElementById('clientFromDate').value);
      let to = toDDMMYYYY(document.getElementById('clientToDate').value);

      showLoading(`Loading ${clientName}'s Report...`);
      try {
        const snap = await db.collection('invoices').get();
        const tbody = document.querySelector('#clientReportTable tbody');
        tbody.innerHTML = '';

        let total = 0, paid = 0, count = 0;

        snap.forEach(doc => {
          const d = doc.data();
          if (d.client !== clientName || d.cancelled) return;
          if (from && d.date < from) return;
          if (to && d.date > to) return;

          const gstInfo = getInvoiceGSTDisplay(d);
          const payable = d.payable || 0;
          const paidAmt = d.paidAmount || 0;
          total += payable;
          paid += paidAmt;
          count++;

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${d.invoiceNo}</td>
            <td>${d.date}</td>
            <td><span class="badge ${gstInfo.badge}">${gstInfo.rate}%</span></td>
            <td>Rs.${payable.toFixed(2)}</td>
            <td>Rs.${paidAmt.toFixed(2)}</td>
            <td>Rs.${(payable - paidAmt).toFixed(2)}</td>
            <td><span class="badge bg-${d.cleared ? 'success' : 'danger'}">${d.cleared ? 'Cleared' : 'Pending'}</span></td>
          `;
          tbody.appendChild(tr);
        });

        if (count === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No data</td></tr>';
        } else {
          tbody.insertAdjacentHTML('beforeend', `
            <tr class="table-success fw-bold">
              <td colspan="3">GRAND TOTAL</td>
              <td>Rs.${total.toFixed(2)}</td>
              <td>Rs.${paid.toFixed(2)}</td>
              <td>Rs.${(total - paid).toFixed(2)}</td>
              <td></td>
            </tr>
          `);
        }
        Swal.close();
      } catch (err) {
        Swal.fire("Error", err.message, "error");
      }
    }

    async function loadItemReport() {
      let from = toDDMMYYYY(document.getElementById('itemFromDate').value);
      let to = toDDMMYYYY(document.getElementById('itemToDate').value);

      showLoading("Generating GST Report...");
      try {
        const snap = await db.collection('invoices').get();
        const itemMap = {};
        let grandNet = 0, grandGST = 0, grandTotal = 0;

        snap.forEach(doc => {
          const inv = doc.data();
          if (inv.cancelled || inv.withoutGST) return;  // WITHOUT GST SKIP
          if (from && inv.date < from) return;
          if (to && inv.date > to) return;

          (inv.items || []).forEach(item => {
            const gstRate = item.gstRate || 18;
            const qty = item.qty || 0;
            const rate = item.rate || 0;
            const discount = item.discount || 0;

            const subtotal = qty * rate;
            const net = subtotal * (1 - discount / 100);
            const gstAmt = net * (gstRate / 100);
            const total = net + gstAmt;

            const key = `${item.name || 'Unknown'}|${item.brand || 'N/A'}|${gstRate}`;
            if (!itemMap[key]) {
              itemMap[key] = { name: item.name, brand: item.brand || 'N/A', unit: item.unit || 'pcs', gstRate, qty: 0, net: 0, gst: 0, total: 0 };
            }
            itemMap[key].qty += qty;
            itemMap[key].net += net;
            itemMap[key].gst += gstAmt;
            itemMap[key].total += total;
          });
        });

        const tbody = document.querySelector('#itemReportTable tbody');
        tbody.innerHTML = '';

        const sorted = Object.values(itemMap).sort((a, b) => b.total - a.total);
        sorted.forEach(it => {
          grandNet += it.net;
          grandGST += it.gst;
          grandTotal += it.total;

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><strong>${it.name}</strong><br><small class="text-muted">${it.brand}</small></td>
            <td>${it.qty}</td>
            <td>${it.unit}</td>
            <td>Rs.${it.net.toFixed(2)}</td>
            <td><span class="badge bg-info">${it.gstRate}%</span></td>
            <td>Rs.${it.gst.toFixed(2)}</td>
            <td class="fw-bold">Rs.${it.total.toFixed(2)}</td>
          `;
          tbody.appendChild(tr);
        });

        // Add WITHOUT GST row if any
        let withoutGSTTotal = 0;
        snap.forEach(doc => {
          const inv = doc.data();
          if (inv.cancelled || !inv.withoutGST) return;
          if (from && inv.date < from) return;
          if (to && inv.date > to) return;
          withoutGSTTotal += inv.payable || 0;
        });

        if (withoutGSTTotal > 0) {
          tbody.insertAdjacentHTML('beforeend', `
            <tr class="table-warning">
              <td colspan="6"><strong>WITHOUT GST SALES</strong></td>
              <td class="fw-bold">Rs.${withoutGSTTotal.toFixed(2)}</td>
            </tr>
          `);
          grandTotal += withoutGSTTotal;
        }

        if (sorted.length === 0 && withoutGSTTotal === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-5">No sales</td></tr>';
        } else {
          tbody.insertAdjacentHTML('beforeend', `
            <tr class="table-dark text-white fw-bold fs-5">
              <td colspan="3">GRAND TOTAL</td>
              <td>Rs.${grandNet.toFixed(2)}</td>
              <td></td>
              <td>Rs.${grandGST.toFixed(2)}</td>
              <td>Rs.${grandTotal.toFixed(2)}</td>
            </tr>
          `);
        }
        Swal.close();
      } catch (err) {
        Swal.fire("Error", err.message, "error");
      }
    }

    async function loadOutstanding() {
      showLoading("Loading Outstanding...");
      const filter = document.querySelector('input[name="outFilter"]:checked').value;

      try {
        const snap = await db.collection('invoices').get();
        const tbody = document.querySelector('#outstandingTable tbody');
        tbody.innerHTML = '';

        snap.forEach(doc => {
          const d = doc.data();
          if (d.cancelled) return;

          const contact = clientContactMap[d.client] || 'N/A';
          const paid = d.paidAmount || 0;
          const pending = (d.payable || 0) - paid;

          if (filter === 'pending' && pending <= 0) return;

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${d.invoiceNo}</td>
            <td>${d.client}</td>
            <td>${contact}</td>
            <td>${d.date}</td>
            <td>Rs.${(d.payable || 0).toFixed(2)}</td>
            <td>Rs.${paid.toFixed(2)}</td>
            <td>Rs.${pending.toFixed(2)}</td>
            <td><span class="badge bg-${pending <= 0 ? 'success' : 'danger'}">${pending <= 0 ? 'Cleared' : 'Pending'}</span></td>
          `;
          tbody.appendChild(tr);
        });

        if (tbody.children.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-5">No outstanding</td></tr>';
        }
        Swal.close();
      } catch (err) {
        Swal.fire("Error", err.message, "error");
      }
    }

    async function loadCancelledReport() {
      showLoading("Loading Cancelled Invoices...");
      try {
        const snap = await db.collection('invoices').where('cancelled', '==', true).get();
        const tbody = document.querySelector('#cancelledTable tbody');
        tbody.innerHTML = '';

        let count = 0;
        snap.forEach(doc => {
          const d = doc.data();
          count++;

          const cancelledDate = d.cancelledAt ?
            (d.cancelledAt.toDate ? d.cancelledAt.toDate().toLocaleDateString('en-GB').split('/').join('-') : d.cancelledAt)
            : d.date;

          const tr = document.createElement('tr');
          tr.className = 'table-danger';
          tr.innerHTML = `
            <td><strong>${d.invoiceNo}</strong></td>
            <td>${d.client}</td>
            <td>${clientContactMap[d.client] || 'N/A'}</td>
            <td>${d.date}</td>
            <td>${cancelledDate}</td>
            <td>Rs.${(d.payable || 0).toFixed(2)}</td>
            <td>${d.cancelReason || 'Not specified'}</td>
          `;
          tbody.appendChild(tr);
        });

        if (count === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-5">No cancelled invoices</td></tr>';
        }
        Swal.close();
      } catch (err) {
        Swal.fire("Error", err.message, "error");
      }
    }

    function downloadTableToExcel(tableId, filename) {
      const table = document.getElementById(tableId);
      if (!table || table.querySelectorAll('tbody tr').length === 0) {
        return Swal.fire("No Data", "Table is empty!", "info");
      }

      const tableClone = table.cloneNode(true);
      tableClone.querySelectorAll('td, th').forEach(cell => {
        const text = cell.innerText.trim();
        if (text.includes('Rs.')) {
          cell.innerText = text.replace('Rs.', '').trim();
        }
      });

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.table_to_sheet(tableClone);
      XLSX.utils.book_append_sheet(wb, ws, "Report");
      XLSX.writeFile(wb, `${filename}_${new Date().toISOString().slice(0, 10)}.xlsx`);
    }

    function downloadTableToPDF(tableId, filename) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('l', 'mm', 'a4');
      doc.setFontSize(20);
      doc.text(`${filename} - KUBER HARDWARE`, 14, 20);
      doc.setFontSize(10);
      doc.text(`Generated: ${new Date().toLocaleString('en-IN')}`, 14, 28);

      doc.autoTable({
        html: `#${tableId}`,
        startY: 35,
        theme: 'grid',
        styles: { fontSize: 9, cellPadding: 3 },
        headStyles: { fillColor: [30, 64, 175], textColor: 255, fontStyle: 'bold' }
      });
      doc.save(`${filename}_${new Date().toISOString().slice(0, 10)}.pdf`);
    }

    window.onload = async () => {
      await setupClientSearchAfterLoad();
    };
  </script>
</body>

</html>
